name: Windows Cross-Compile Build

# Trigger on push or pull request to the main branch
on:
  push:
    branches:
      - feature/add-macos-support
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest  # GitHub-hosted Windows runner

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Install MSYS2 manually
      - name: Install MSYS2
        run: |
          # Download and install MSYS2
          curl -L https://github.com/msys2/msys2-installer/releases/download/2022-08-01/msys2-x86_64-2022-08-01.exe -o msys2-installer.exe
          start /wait msys2-installer.exe --no-admin --root $HOME/msys2

      # Step 3: Install necessary packages using MSYS2's pacman
      - name: Install build tools with MSYS2
        run: |
          # Install MSYS2 base-devel and mingw-w64-x86_64 toolchain
          $HOME/msys2/usr/bin/pacman -Syu --noconfirm
          $HOME/msys2/usr/bin/pacman -S --noconfirm base-devel mingw-w64-x86_64-toolchain

      # Step 4: Download ARM GCC 5.3-2016q1 Installer
      - name: Download ARM GCC 5.3-2016-q1 Installer
        run: |
          # Download the ARM GCC 5.3-2016-q1 installer
          curl -L https://developer.arm.com/-/media/Files/downloads/gnu-rm/5_3-2016q1/gcc-arm-none-eabi-5_3-2016q1-20160330-win32.exe -o $HOME/gcc-arm-none-eabi-5_3-2016q1.exe

      # Step 5: Install ARM GCC 5.3-2016-q1 Toolchain
      - name: Install ARM GCC 5.3-2016-q1
        run: |
          # Run the installer
          $HOME/gcc-arm-none-eabi-5_3-2016q1.exe /S /D=$HOME/arm-toolchain

      # Step 6: Set up the toolchain environment
      - name: Set up environment for cross-compilation
        run: |
          # Set the PATH to the ARM toolchain bin directory
          echo "PATH=$HOME/arm-toolchain/bin:$PATH" >> $GITHUB_ENV
          echo "ARM_PATH=$HOME/arm-toolchain/bin" >> $GITHUB_ENV

      # Step 7: Run cross-compilation with Make
      - name: Run cross-compilation with Make
        run: |
          # Use the ARM GCC cross-compiler for make
          cd firmware
          make CC=$ARM_PATH/arm-none-eabi-gcc
